<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='../../../../static/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='../../../../static/volunteers/chat/chat.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&display=swap" rel="stylesheet">
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
  />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="../../../static/reusable/volunteer-header.js"></script>
  <title>Volunteer chat</title>
</head>
<body>

  <volunteer-header></volunteer-header>


  <div class="chat-title-text">
    <h2 class="chat-title">Chat</h2>
    <h3 class="chat-subtitle">with women who are seeking help and support.</h3>
    <!--<div class="volunteer-status">
        <i class="fa-solid fa-circle" id="statusIcon"></i>
        <span id="statusText">This chat is online</span>-->
    </div>
    
  </div>
  <div class="main-section-wrapper">
    <div class="main-section">
        <div class="chat-container">
            <div class="messages-container" id="messages"></div>
            <div class="message-input-container">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>
        
        <div class="info-about-chat">
        <div id="info-icon">
            <i class="fa-solid fa-circle-info"></i>   
        </div>
        <ul class="resources">
            <li class="resources-list-item"><a href="/resources"><i class="fa-solid fa-building-shield list-icon"></i>Find Police</a></li>
            <li class="resources-list-item"><a href="/resources"><i class="fa-solid fa-user-tie list-icon"></i>Find Lawyer</a></li>
            <li class="resources-list-item"><a href="/resources"><i class="fa-solid fa-section list-icon"></i>Find Laws</a></li>
            <li class="resources-list-item"><a href="/resources"><i class="fa-solid fa-circle-question list-icon"></i>Violence?</a></li>
        </ul>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const statusIcon = document.getElementById('statusIcon');
  const statusText = document.getElementById('statusText');

  if (!messagesDiv || !messageInput || !sendButton) {
    console.warn('Chat markup missing: ensure #messages, #messageInput and #sendButton are present in the HTML.');
    return;
  }

  const socket = io();
  let session_id = null;
  let sessionRefreshInterval = null;

  sendButton.disabled = true;

  socket.on('connect', () => {
    console.log('socket connected', socket.id);
    loadAvailableSessions();
    sessionRefreshInterval = setInterval(() => { if (!session_id) loadAvailableSessions(); }, 5000);
  });

  async function loadAvailableSessions() {
    try {
      const res = await fetch('/active_sessions');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const sessions = await res.json();

      const count = Array.isArray(sessions) ? sessions.length : 0;
      updateSessionStatus(count);

      if (count > 0 && !session_id) {
        session_id = sessions[0].session_id;
        console.log('joining session', session_id);
        socket.emit('volunteer_connect', { session_id });
        sendButton.disabled = false;
        clearInterval(sessionRefreshInterval);
      } else if (session_id) {
        updateSessionStatus(1);
      }
    } catch (err) {
      console.error('Failed to fetch active sessions:', err);
      if (statusText) statusText.textContent = "Connection error";
      if (statusIcon) statusIcon.classList.add('volunteer-offline');
    }
  }

  function updateSessionStatus(count) {
    if (!statusText || !statusIcon) return;
    if (count > 0) {
      statusIcon.classList.remove('volunteer-offline');
      statusIcon.classList.add('volunteer-online');
      statusText.textContent = `${count} active session${count !== 1 ? 's' : ''}`;
    } else {
      statusIcon.classList.add('volunteer-offline');
      statusIcon.classList.remove('volunteer-online');
      statusText.textContent = "No active sessions";
    }
  }

  socket.on('new_message', (data) => {
    displayMessage(data.text, false);
  });

  socket.on('volunteer_joined', (data) => {
    console.log('volunteer_joined event:', data);
  });

  function sendMessage() {
    const msg = messageInput.value.trim();
    if (msg === "" || !session_id) return;

    console.log('sending volunteer_message', { session_id, text: msg });
    socket.emit('volunteer_message', { session_id, text: msg });

    displayMessage(msg, true);
    messageInput.value = "";
  }

  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

  function displayMessage(message, isSender = false) {
    const messageContainer = document.createElement('div');
    const messageElement = document.createElement('div');
    messageElement.textContent = message;

    messageContainer.classList.add('message-container');
    if (isSender) {
      messageContainer.classList.add('sender-message-container');
      messageElement.classList.add('message-bubble', 'sender-message-bubble');
    } else {
      messageElement.classList.add('message-bubble');
    }

    messageContainer.appendChild(messageElement);
    messagesDiv.appendChild(messageContainer);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
});
</script>

</body>
</html>
